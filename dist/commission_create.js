function onSliderChange(){const e=document.getElementsByClassName("step"),t=parseInt(document.getElementById("checkpoints").value);let n=0;for(;n<4;)n<t?e[n].classList.toggle("invisible",!1):e[n].classList.toggle("invisible",!0),n++}function onSliderInput(){const e=document.getElementById("checkpoints");document.getElementById("checkpoints-output").textContent=e.value}function stepsBarFragment(e){const t=document.createElement("div");return t.className="steps-bar-fragment",t.classList.toggle("completed",e),t}function stepsBarCircle(e){const t=document.createElement("div");t.className="steps-bar-circle-wrapper";const n=document.createElement("div");return n.className="steps-bar-circle",n.classList.toggle("current",e),t.appendChild(n),t}function updatePreview(e,t=null){let n=document.querySelector("#preview-section"),i=document.querySelector("#file-upload-section");e%2!=0?(n.classList.toggle("invisible",!1),i.classList.toggle("invisible",!0),t?setCanvasImageFromBase64(t,"uploaded-file"):generatePreview(null)):(n.classList.toggle("invisible",!0),i.classList.toggle("invisible",!1))}function updateMilestoneSectionVisibilityAndText(e){const t=e.title,n=e.price,i=e.description,l=e.preview,s=e.status;document.getElementById("current-step-title").textContent=`${t} - $${formatPrice(n)}`,document.getElementById("current-step-description").textContent=i,updatePreview(s,l),s<2?(document.querySelector("#paypal-section").classList.toggle("invisible",!1),document.querySelector("#download-button").classList.toggle("invisible",!0),document.querySelector("#paypal-section-complete").classList.toggle("invisible",!0)):(document.querySelector("#paypal-section").classList.toggle("invisible",!0),document.querySelector("#download-button").classList.toggle("invisible",!1),document.querySelector("#paypal-section-complete").classList.toggle("invisible",!1))}function updateProgressBar(e,t){const n=document.querySelectorAll(".steps-bar-circle").length,i=document.querySelector("#steps-bar");for(;i.firstElementChild;)i.firstElementChild.remove();i.appendChild(stepsBarFragment(!0));for(let l=0;l<n;l++){let n=stepsBarCircle(l===t-1);i.appendChild(n),i.appendChild(stepsBarFragment(l<e-1))}setCircleCallbacks(current,current);const l=document.querySelectorAll(".steps-bar-circle"),s=l[t-1];if(!s.classList.contains("current")){l[t-2].classList.toggle("current",!1)}s.classList.toggle("current",!0)}function setCircleAsCurrent(e){const t=document.querySelector(".steps-bar-circle.current"),n=document.querySelectorAll(".steps-bar-circle")[e-1];t.classList.toggle("current",!1),n.classList.toggle("current",!0)}function circleCallback(e,t,n){return async()=>{if(e>=n||e===t-1)return;let i=await fetchCommissionStep(commissionID,e+1);setCircleAsCurrent(i.stepNumber),updateMilestoneSectionVisibilityAndText(i.step);const l=i.step.evidence;for(let e=0;e<3;e++){let t=e<l.length?l[e].file:null,n=e<l.length?l[e].description:null;updateEvidenceSlot(t,e+1,l.length,i.step.status,commissionID,n)}document.querySelector("#download-button").onclick=()=>requestCommissionDownload(i.commission,e+1,i.step.title);const s=document.querySelectorAll(".steps-bar-circle");for(let e=0;e<=n-1;e++)s[e].onclick=circleCallback(e,i.stepNumber,i.current)}}function setCircleCallbacks(e,t){const n=document.querySelectorAll(".steps-bar-circle");for(let i=0;i<t;i++){n[i].onclick=circleCallback(i,e,t)}}function createEvidenceSlots(){const e=document.querySelector(".evidence-box");for(let t=0;t<3;t++){let n=document.createElement("div");n.classList.toggle("evidence-slot-container",!0);let i=document.createElement("div");i.classList.toggle("evidence-slot",!0);let l=document.createElement("input");l.setAttribute("type","text"),l.setAttribute("placeholder","Enter a short description"),l.classList.toggle("evidence-description",!0),l.classList.toggle("submit-button-text",!0);let s=document.createElement("span");i.append(s),n.dataset.index=t+1;let c=document.createElement("div");c.classList.toggle("evidence-button-container");let o=document.createElement("input");o.type="file",o.classList.toggle("evidence-button",!0),o.id=`e-file${n.dataset.index}`,o.accept="image/*";let r=document.createElement("label");r.textContent="+",r.setAttribute("for",`e-file${n.dataset.index}`),c.append(o),c.append(r),c.classList.toggle("invisible",!0);let a=document.createElement("button");a.type="button",a.textContent="-",a.classList.toggle("evidence-remove",!0),n.appendChild(i),n.appendChild(l),n.appendChild(c),n.appendChild(a),e.appendChild(n)}}function updateEvidenceSlot(e,t,n,i,l,s){if(toggleEvidenceButtonsDisabled(t,i),3==i)toggleEvidenceButtonsVisibility(t,!1,!1);else if(e){toggleEvidenceButtonsVisibility(t,!1,!0);document.querySelector(`.evidence-slot-container[data-index='${t}'] > .evidence-remove`).setAttribute("onclick",`removeEvidence(${t}, '${l}', ${i})`)}else if(t==n+1){toggleEvidenceButtonsVisibility(t,!0,!1);document.querySelector(`.evidence-slot-container[data-index='${t}'] > .evidence-button-container > input`).setAttribute("onchange",`uploadEvidence(this, '${l}', '${t}')`)}else toggleEvidenceButtonsVisibility(t,!1,!1);const c=document.querySelector(`.evidence-slot-container[data-index='${t}'] > .evidence-slot`),o=document.querySelector(`.evidence-slot-container[data-index='${t}'] > .evidence-slot > span`);e?(c.setAttribute("onclick",`activateEvidenceCard('${e}')`),c.classList.toggle("disabled",!1),o.textContent=s,o.offsetWidth>c.clientWidth&&(o.textContent=truncateString(s,c.clientWidth/15))):(c.setAttribute("onclick",void 0),c.classList.toggle("disabled",!0),o.textContent=void 0);const r=document.querySelector(`.evidence-slot-container[data-index='${t}'] > .evidence-description`);i<2&&t==n+1?(r.classList.toggle("invisible",!1),c.classList.toggle("invisible",!0)):(r.classList.toggle("invisible",!0),c.classList.toggle("invisible",!1))}function toggleEvidenceButtonsVisibility(e,t,n){const i=document.querySelector(`.evidence-slot-container[data-index='${e}'] > .evidence-button-container`),l=document.querySelector(`.evidence-slot-container[data-index='${e}'] > .evidence-remove`);t?i.classList.toggle("invisible",!1):i.classList.toggle("invisible",!0),n?l.classList.toggle("invisible",!1):l.classList.toggle("invisible",!0)}function toggleEvidenceButtonsDisabled(e,t){const n=document.querySelector(`.evidence-slot-container[data-index='${e}'] > .evidence-button-container > label`),i=document.querySelector(`.evidence-slot-container[data-index='${e}'] > .evidence-remove`);2==t?(n.classList.toggle("disabled",!0),i.classList.toggle("disabled",!0)):(n.classList.toggle("disabled",!1),i.classList.toggle("disabled",!1))}function displayMilestone(e,t,n,i,l){document.querySelector("#download-button").onclick=()=>requestCommissionDownload(l,e,i.title);const s=document.getElementById("steps-bar");s.appendChild(stepsBarFragment());for(let i=0;i<t;i++){let t=stepsBarCircle(i===e-1);s.appendChild(t),s.appendChild(stepsBarFragment(i<e-1||n))}setCircleCallbacks(e,e),updateMilestoneSectionVisibilityAndText(i),createEvidenceSlots(),evidenceArray=i.evidence;for(let e=0;e<3;e++){let t=e<evidenceArray.length?evidenceArray[e].file:null,n=e<evidenceArray.length?evidenceArray[e].description:null;updateEvidenceSlot(t,e+1,evidenceArray.length,i.status,l,n)}i.status<2&&paypal.Buttons({createOrder:async function(e,t){let n=new FormData;n.append("commission",l);const i=await fetch("../php/commission_order.php",{method:"POST",body:n});return await i.text()},onApprove:function(e,t){return t.order.capture().then((function(e){completeCommissionPayment(l,e.id,"filename").then((e=>{if(e){updateProgressBar(e.current,e.stepNumber),updateMilestoneSectionVisibilityAndText(e.currentStep),setCircleCallbacks(e.stepNumber,e.current);const t=e.currentStep.evidence;for(let n=0;n<3;n++){let i=n<t.length?t[n].file:null,s=n<t.length?t[n].description:null;updateEvidenceSlot(i,n+1,t.length,e.currentStep.status,l,s)}e.current>e.stepNumber&&requestCommissionDownload(e.commission,e.stepNumber,e.currentStep.title)}}))}))}}).render("#paypal-button-container")}function createCommission(e){e.preventDefault();let t=document.getElementById("email").value,o=document.getElementById("confirm").value;if(!validateEmail(t,o))return!1;let r=parseInt(document.getElementById("checkpoints").value);if(isNaN(r)||r<0||r>4)return!1;let n=[];for(let e=1;e<=r;e++){let t=document.getElementById(`step${e}-price`).value;if(isNaN(t)||""===t)return alert("Error: Invalid Price"),!1;let o=document.getElementsByName(`step${e}`)[0].value,r=document.getElementById(`step${e}-description`).value;n.push({title:o,price:t,description:r})}const s=document.querySelector('button[type="submit"]');toggleProgressBar(s,!0);const i={numSteps:r,email:t,steps:n},l=JSON.stringify(i);fetch("../php/create_commission.php",{method:"POST",body:l,header:{"Content-Type":"application/json"}}).then((e=>{if(e.status>=400){throw document.querySelector("#main").reset(),e.text()}return e.text()})).then((e=>{let t=removeQuotes(e);document.querySelector("#main").reset(),document.getElementById("checkpoints-output").textContent=1,onSliderChange();let o=`${extractURLRoot(document.location.href)}/commission/${t}`;toggleProgressBar(s,!1),activateResultCard(o)})).catch((e=>{toggleProgressBar(s,!1),console.error("Error:",e)}))}function createListing(e){e.preventDefault();let t=document.getElementById("email").value,o=document.getElementById("confirm").value;if(!validateEmail(t,o))return!1;let r=document.getElementById("price").value;if(isNaN(r)||""===r)return alert("Error: Invalid Price"),!1;let n=document.getElementById("file").files[0];if(!n)return alert("Error: No File"),!1;let s=n.name,i=n.size;const l=document.querySelector('button[type="submit"]');return toggleProgressBar(l,!0),new Promise(((e,t)=>{let o=new FileReader;o.onload=function(){e(o.result)},o.readAsDataURL(n)})).then((function(e){let o=savePreviewAsBase64(),n=new FormData;n.append("email",t),n.append("price",r),n.append("preview",o),n.append("file",e),n.append("name",s),n.append("size",i),fetch("../php/submit.php",{method:"POST",body:n}).then((e=>{if(413==e.status&&alert("The file is too big. The maximum file size is 4MB"),e.status>=400){throw document.getElementById("main").reset(),defaultPreview(),e.text()}return e.text()})).then((e=>{let t=removeQuotes(e),o=`${extractURLRoot(document.location.href)}/listing/${t}`;document.getElementById("main").reset(),toggleProgressBar(l,!1),defaultPreview(),activateResultCard(o)})).catch((e=>{console.error("Error:",e),toggleProgressBar(l,!1)}))}),(function(e){console.error(e)})),!0}function requestDownload(e,t,o){let r=new FormData;r.append("listing",e),r.append("order",t),fetch("../php/download.php",{method:"POST",body:r}).then((e=>e.json())).then((e=>{let t=document.createElement("a");t.download=o||"download",t.href=e,t.click()})).catch((e=>{console.error("Error:",e)}))}function requestCommissionDownload(e,t,o){fetch(`../php/commission_download.php?commission=${e}&step=${t}`,{method:"GET",headers:{"Content-Type":"application/json"}}).then((e=>{if(200!=e.status)throw new Error(`Status code: ${e.status}`);return e.json()})).then((e=>{let t=document.createElement("a");t.download=o||"download",t.href=e,t.click()})).catch((e=>{console.error("Error:",e)}))}async function completeCommissionPayment(e,t,o){let r=new FormData;return r.append("commission",e),r.append("order",t),new Promise((e=>{fetch("../php/commission_pay.php",{method:"POST",body:r}).then((e=>e.json())).then((t=>{e(t)})).catch((e=>{console.error("Error:",e)}))}))}function uploadCommissionFile(e,t){e.preventDefault();let o=document.getElementById("file").files[0];if(!o)return alert("Error: No File"),!1;const r=document.querySelector('button[type="submit"]');toggleProgressBar(r,!0),new Promise(((e,t)=>{let r=new FileReader;r.onload=function(){e(r.result)},r.readAsDataURL(o)})).then((function(e){let o=savePreviewAsBase64(),n=new FormData;n.append("preview",o),n.append("file",e),n.append("commission",t),fetch("../php/commission_file_upload.php",{method:"POST",body:n}).then((e=>{if(413==e.status){throw alert("The file is too big. The maximum file size is 4MB"),document.querySelector("#file").value="",defaultPreview(),e.text()}return e.json()})).then((e=>{if(toggleProgressBar(r,!1),defaultPreview(),updateProgressBar(e.current,e.stepNumber),updateMilestoneSectionVisibilityAndText(e.currentStep),setCircleCallbacks(e.stepNumber,e.current),e.current!==e.stepNumber){const t=e.currentStep.evidence;for(let o=0;o<3;o++){let r=o<t.length?t[o].file:null,n=o<t.length?t[o].description:null;updateEvidenceSlot(r,o+1,t.length,e.currentStep.status,e.commission,n)}}})).catch((e=>{toggleProgressBar(r,!1),console.error("Error:",e)}))})).catch((e=>{toggleProgressBar(r,!1),console.error("Error:",e)}))}function sendMessage(e){e.preventDefault();let t=document.querySelector("#email").value,o=document.querySelector("#message").value;if(!isEmailAddress(t))return alert("Enter a valid email"),!1;if(""===o)return alert("Message body empty"),!1;const r=document.querySelector('button[type="submit"]');toggleProgressBar(r,!0);let n=new FormData;n.append("email",t),n.append("message",o),fetch("../php/send_message.php",{method:"POST",body:n,header:{"Content-Type":"application/json"}}).then((e=>{document.querySelector("#main").reset(),toggleProgressBar(r,!1)})).error((e=>{toggleProgressBar(r,!1),console.error("Error: ",e)}))}async function fetchCommissionStep(e,t){return new Promise((o=>{fetch(`../php/commission_fetch_step.php?commission=${e}&step=${t}`,{method:"GET",header:{"Content-Type":"application/json"}}).then((e=>{if(200!==e.status)throw new Error(`Status code: ${e.status}`);o(e.json())})).then((e=>e)).catch((e=>{console.error("Error",e)}))}))}function uploadEvidence(e,t,o){let r=e.files[0];if(!r)return console.error("Error: Invalid file"),!1;const n=document.querySelector(`.evidence-slot-container[data-index='${o}']`);toggleProgressBar(n,!0),new Promise(((e,t)=>{let o=new FileReader;o.onload=function(){e(o.result)},o.readAsDataURL(r)})).then((function(e){const o=n.querySelector("input").value;let r=new FormData;r.append("file",e),r.append("commission",t),r.append("description",o),fetch("../php/commission_add_evidence.php",{method:"POST",body:r}).then((e=>(413==e.status&&(toggleProgressBar(descriptionField.false),alert("The file is too big. The maximum file size is 4MB")),e.json()))).then((e=>{toggleProgressBar(n,!1);const t=e.evidenceCount;updateEvidenceSlot(e.newEvidence,t,t,0,e.commission,e.description);for(let o=t;o<3;o++)updateEvidenceSlot(null,o+1,t,0,e.commission,null);updatePreview(0)})).catch((e=>{toggleProgressBar(n,!1),console.error("Error",e)}))}))}function removeEvidence(e,t,o){let r=new FormData;r.append("commission",t),r.append("evidence",e),fetch("../php/commission_delete_evidence.php",{method:"POST",body:r}).then((e=>e.json())).then((e=>{for(let o=0;o<3;o++){let r=o<e.length?e[o].file:null,n=o<e.length?e[o].description:null;updateEvidenceSlot(r,o+1,e.length,0,t,n)}updatePreview(0)})).catch((e=>{console.error("Error",e)}))}function isImage(t){return!(!t||!t.name.toLowerCase().match(".(png|jpg|gif|jpeg)$"))}function isEmailAddress(t){return!(!t||!t.match("^[^@]+@[^@]+.[^@]+$"))}function formatBytes(t,r=0){if(units=["bytes","KB","MB"],t<1e3||3===r)return t.toString(10)+" "+units[r];let n=t/1e3;return n=n.toFixed(2),formatBytes(n,++r)}function formatPrice(t){return t.toFixed(2)}function truncateString(t,r){return t.length>r?t.substring(0,r)+"...":t}function validateEmail(t,r){return t!==r?(alert("Error: Email and Email Confirm must match"),!1):!!isEmailAddress(t)||(alert("Error: Invalid Email"),!1)}function extractURLRoot(t){let r=0,n=0;for(;r<3&&-1!==n;)n=t.indexOf("/",n+1),r++;return t.substring(0,n)}function removeQuotes(t){return t.replace('"',"")}function toggleButtonProgressBar(e){document.getElementById("submit-button-text").classList.toggle("disabled",e),document.getElementById("progress-bar").classList.toggle("invisible",!e)}function toggleProgressBar(e,t){e.querySelector(".submit-button-text").classList.toggle("disabled",t),e.classList.contains("evidence-slot-container")||e.querySelector(".progress-bar").classList.toggle("invisible",!t)}function priceInputCallback(e){e.srcElement.valueAsNumber>1e3&&(e.srcElement.valueAsNumber=1e3)}function activateCard(e){let t=document.getElementById(e);-1!==t.className.indexOf("disabled")&&(t.className="card"),document.getElementById("main").className="content blur";let a=Array.from(document.getElementsByTagName("input")),n=Array.from(document.getElementsByTagName("button"));a.concat(n).forEach((e=>{-1===e.className.indexOf("card-button")&&(e.disabled=!0)}));let c=Array.from(document.getElementsByClassName("steps-bar-circle")),l=Array.from(document.getElementsByTagName("a"));c.concat(l).forEach((e=>{e.classList.toggle("disabled",!0)}));let o=document.getElementsByClassName("clickable-rect");for(const e of o)e.onclick=null;let m=document.getElementById("file");m&&(m.className="file-button")}function disableCard(e){document.getElementById(e).className="card disabled",document.getElementById("main").className="content";let t=Array.from(document.getElementsByTagName("input")),a=Array.from(document.getElementsByTagName("button"));t.concat(a).forEach((e=>{e.disabled=!1}));let n=Array.from(document.getElementsByClassName("steps-bar-circle")),c=Array.from(document.getElementsByTagName("a"));n.concat(c).forEach((e=>{e.classList.toggle("disabled",!1)}));let l=document.getElementsByClassName("clickable-rect");for(const e of l)e.onclick=toggleBurgerMenu;let o=document.getElementById("file");o&&(o.className="file-button hoverable")}function cardActive(e){return-1!==document.getElementById(e).className.indexOf("disabled")}function activateResultCard(e){document.getElementById("copy-button").innerText="Copy";document.getElementById("result-card-text").innerText=e,activateCard("result-card")}async function copyLink(){const e=document.getElementById("result-card-text").innerText;await navigator.clipboard.writeText(e);document.getElementById("copy-button").innerText="Copied!"}function activateEvidenceCard(e){document.querySelector("#evidence-card img").src=e,activateCard("evidence-card")}